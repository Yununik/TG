# Техническое Задание: Telegram Mini App для Автоматизации Юридического Документооборота

## 1. Общее Описание Проекта

### 1.1. Назначение
Telegram Mini App (TMA) для автоматизации создания юридических документов (договоров) с возможностью:
- Управления профилем пользователя с реквизитами
- Парсинга реквизитов контрагента из текста
- Генерации PDF-документов на основе шаблонов
- Наложения подписи на документы

### 1.2. Целевая Аудитория
Юридические лица и индивидуальные предприниматели, работающие с договорами и документами.

---

## 2. Функциональные Требования

### 2.1. Профиль Пользователя
**FR-1.1:** Хранение реквизитов организации/ИП:
- ИНН (обязательно)
- ОГРН/ОГРНИП (обязательно)
- Наименование организации/ФИО ИП
- Юридический адрес
- Почтовый адрес
- Банковские реквизиты:
  - Наименование банка
  - БИК
  - Расчетный счет
  - Корреспондентский счет
- Контактные данные (телефон, email)

**FR-1.2:** Загрузка и хранение изображения подписи:
- Формат: PNG
- Размер: до 2MB
- Предпросмотр загруженной подписи
- Возможность удаления и замены

**FR-1.3:** Редактирование профиля:
- Сохранение изменений
- Валидация обязательных полей
- Автосохранение в локальное хранилище

### 2.2. Конструктор Договоров
**FR-2.1:** Парсинг реквизитов контрагента:
- Ввод текстовых данных контрагента (свободный текст)
- Автоматическое извлечение:
  - ИНН
  - ОГРН/ОГРНИП
  - Наименование
  - Адреса
  - Банковские реквизиты
- Отображение распознанных данных в структурированном виде
- Возможность ручной корректировки

**FR-2.2:** Редактируемые шаблоны договоров:
- Система шаблонов (Contract-as-Code)
- Поддержка переменных-плейсхолдеров:
  - `{{company_name}}` - наименование организации
  - `{{inn}}` - ИНН
  - `{{ogrn}}` - ОГРН
  - `{{address}}` - адрес
  - `{{bank_name}}` - банк
  - `{{account}}` - расчетный счет
  - И другие реквизиты
- Визуальный редактор шаблона
- Предпросмотр результата перед генерацией

**FR-2.3:** Подстановка данных:
- Автоматическая замена плейсхолдеров данными из профиля пользователя и контрагента
- Поддержка условной логики (если поле пустое, скрыть блок)
- Форматирование дат и чисел

### 2.3. PDF Engine
**FR-3.1:** Генерация PDF:
- Создание PDF на основе шаблона с подставленными данными
- Сохранение форматирования текста
- Поддержка многостраничных документов

**FR-3.2:** Наложение подписи:
- Опция при экспорте: "С подписью" / "Без подписи"
- Наложение изображения подписи на заданные координаты
- Настройка размера подписи
- Позиционирование (нижний правый угол, нижний левый угол, кастомные координаты)

**FR-3.3:** Экспорт и скачивание:
- Скачивание PDF-файла на устройство
- Именование файла: `Договор_<Контрагент>_<Дата>.pdf`

### 2.4. Telegram UI
**FR-4.1:** Адаптация под Telegram:
- Использование цветовой схемы Telegram (светлая/темная тема)
- Интеграция с Telegram WebApp SDK
- Поддержка нативных элементов Telegram (кнопки, меню)
- Адаптивная верстка для мобильных устройств

**FR-4.2:** Навигация:
- Главная страница
- Профиль пользователя
- Конструктор договоров
- История документов (опционально)

---

## 3. Технологический Стек

### 3.1. Frontend
- **Framework:** Next.js 14+ (App Router)
- **Language:** TypeScript
- **Styling:** Tailwind CSS
- **UI Components:** Shadcn/UI
- **Icons:** Lucide React
- **PDF Generation:** pdf-lib
- **State Management:** Zustand (для глобального состояния)
- **Form Handling:** React Hook Form + Zod (валидация)
- **Storage:** IndexedDB (via Dexie.js) для локального хранения

### 3.2. Backend (опционально, для будущего расширения)
- **Runtime:** Node.js
- **Framework:** Next.js API Routes (или отдельный Express/Fastify)
- **Database:** PostgreSQL (для облачного хранения)
- **File Storage:** AWS S3 / Cloudflare R2 (для подписей и документов)

### 3.3. Telegram Integration
- **SDK:** @twa-dev/sdk или официальный Telegram WebApp SDK
- **Bot:** Node.js + node-telegram-bot-api (для бота-обертки)

### 3.4. Development Tools
- **Package Manager:** pnpm (или npm/yarn)
- **Linting:** ESLint + Prettier
- **Type Checking:** TypeScript strict mode

---

## 4. Архитектура Хранения Данных

### 4.1. Локальное Хранилище (IndexedDB)

**Схема БД:**

```typescript
// Таблица: user_profile
{
  id: string (primary key)
  telegramUserId: number
  companyName: string
  inn: string
  ogrn: string
  legalAddress: string
  postalAddress: string
  bankName: string
  bik: string
  account: string
  correspondentAccount: string
  phone: string
  email: string
  signatureImage: Blob (base64 или Blob URL)
  updatedAt: Date
}

// Таблица: templates
{
  id: string (primary key)
  name: string
  content: string (HTML/Markdown шаблон)
  variables: string[] (список используемых переменных)
  createdAt: Date
  updatedAt: Date
}

// Таблица: contracts
{
  id: string (primary key)
  templateId: string
  counterpartyData: object (реквизиты контрагента)
  generatedPdf: Blob (опционально, для кэширования)
  createdAt: Date
}

// Таблица: counterparties
{
  id: string (primary key)
  name: string
  inn: string
  ogrn: string
  // ... другие реквизиты
  createdAt: Date
}
```

### 4.2. Стратегия Хранения

**Локально (IndexedDB):**
- Профиль пользователя
- Шаблоны договоров
- История созданных договоров (метаданные)
- Кэш подписей (как Blob)

**Облачно (будущее расширение):**
- Синхронизация между устройствами
- Резервное копирование
- Общие шаблоны

---

## 5. Алгоритм Обработки PDF

### 5.1. Процесс Генерации PDF

```
1. Парсинг шаблона
   ├─ Извлечение текста шаблона
   ├─ Поиск плейсхолдеров ({{variable}})
   └─ Создание карты переменных

2. Подстановка данных
   ├─ Замена плейсхолдеров значениями из:
   │  ├─ Профиля пользователя
   │  └─ Данных контрагента
   ├─ Обработка условных блоков
   └─ Форматирование (даты, числа)

3. Конвертация в PDF
   ├─ Создание PDFDocument (pdf-lib)
   ├─ Добавление страниц
   ├─ Размещение текста с форматированием
   └─ Расчет позиций элементов

4. Наложение подписи (если выбрано)
   ├─ Загрузка изображения подписи
   ├─ Расчет координат размещения
   ├─ Вставка изображения на PDF
   └─ Применение прозрачности (если нужно)

5. Экспорт
   ├─ Генерация Blob
   ├─ Создание download link
   └─ Триггер скачивания
```

### 5.2. Технические Детали

**Использование pdf-lib:**
```typescript
import { PDFDocument, rgb } from 'pdf-lib';

// Создание документа
const pdfDoc = await PDFDocument.create();

// Добавление страницы
const page = pdfDoc.addPage([595, 842]); // A4

// Добавление текста
page.drawText(text, {
  x: 50,
  y: 800,
  size: 12,
  color: rgb(0, 0, 0),
});

// Вставка изображения подписи
const signatureImage = await pdfDoc.embedPng(signatureBlob);
page.drawImage(signatureImage, {
  x: 400,
  y: 50,
  width: 150,
  height: 50,
});
```

**Координаты подписи:**
- По умолчанию: нижний правый угол (x: 400, y: 50)
- Настраиваемые координаты через UI
- Адаптация под размер страницы

---

## 6. Инструкция по Развертыванию

### 6.1. Настройка BotFather

1. **Создание бота:**
   ```
   /newbot
   Следуйте инструкциям для создания бота
   Сохраните токен бота
   ```

2. **Настройка Mini App:**
   ```
   /newapp
   Выберите вашего бота
   Укажите название приложения
   Загрузите иконку (512x512px)
   Укажите описание
   ```

3. **Получение URL Mini App:**
   - После создания получите URL вида: `https://t.me/your_bot/your_app`
   - Или используйте прямую ссылку на ваш хостинг

4. **Настройка команд бота:**
   ```
   /setcommands
   start - Запустить приложение
   profile - Открыть профиль
   contract - Создать договор
   ```

### 6.2. Локальная Разработка с Туннелем

**Вариант 1: ngrok**
```bash
# Установка ngrok
brew install ngrok  # macOS
# или скачайте с https://ngrok.com

# Запуск туннеля
ngrok http 3000

# Получите HTTPS URL (например: https://abc123.ngrok.io)
# Используйте этот URL в BotFather для Mini App
```

**Вариант 2: Cloudflare Tunnel (cloudflared)**
```bash
# Установка
brew install cloudflared

# Запуск
cloudflared tunnel --url http://localhost:3000

# Получите HTTPS URL
```

**Вариант 3: localtunnel**
```bash
npm install -g localtunnel
lt --port 3000
```

### 6.3. Настройка Переменных Окружения

Создайте файл `.env.local`:
```env
NEXT_PUBLIC_TELEGRAM_BOT_TOKEN=your_bot_token
NEXT_PUBLIC_TELEGRAM_WEBAPP_URL=https://your-domain.com
NEXT_PUBLIC_API_URL=http://localhost:3000/api
```

### 6.4. Production Развертывание

**Рекомендуемые платформы:**
- Vercel (оптимально для Next.js)
- Railway
- Render
- DigitalOcean App Platform

**Шаги:**
1. Подключите репозиторий к платформе
2. Настройте переменные окружения
3. Укажите production URL в BotFather
4. Включите HTTPS (обязательно для Telegram Mini Apps)

---

## 7. Step-by-Step Roadmap

### Этап 1: Настройка Проекта и Базовой Инфраструктуры
**Цель:** Создать рабочую среду разработки
- [ ] Инициализация Next.js проекта
- [ ] Настройка TypeScript, Tailwind, ESLint
- [ ] Установка зависимостей (Shadcn/UI, pdf-lib, Telegram SDK)
- [ ] Настройка структуры папок
- [ ] Создание базовых конфигурационных файлов
- [ ] Настройка Telegram WebApp SDK
- [ ] Создание базового layout с Telegram UI

**Ожидаемый результат:** Рабочее приложение, открывающееся в Telegram

### Этап 2: Профиль Пользователя
**Цель:** Реализовать управление профилем и реквизитами
- [ ] Создание схемы IndexedDB (Dexie.js)
- [ ] Разработка формы профиля с валидацией
- [ ] Реализация загрузки изображения подписи
- [ ] Сохранение данных в IndexedDB
- [ ] Отображение профиля с предпросмотром подписи
- [ ] Редактирование и обновление данных

**Ожидаемый результат:** Полнофункциональный профиль с сохранением данных

### Этап 3: Парсер Реквизитов Контрагента
**Цель:** Автоматическое извлечение данных из текста
- [ ] Разработка алгоритма парсинга (регулярные выражения)
- [ ] Создание UI для ввода текста контрагента
- [ ] Реализация извлечения: ИНН, ОГРН, наименование, адреса, банк
- [ ] Отображение распознанных данных в структурированной форме
- [ ] Возможность ручной корректировки
- [ ] Сохранение контрагентов в IndexedDB

**Ожидаемый результат:** Работающий парсер с высокой точностью распознавания

### Этап 4: Конструктор Шаблонов
**Цель:** Создание и редактирование шаблонов договоров
- [ ] Разработка системы шаблонов (Contract-as-Code)
- [ ] Создание визуального редактора шаблонов
- [ ] Реализация системы плейсхолдеров
- [ ] Подстановка данных из профиля и контрагента
- [ ] Предпросмотр результата
- [ ] Сохранение шаблонов в IndexedDB
- [ ] Управление шаблонами (создание, редактирование, удаление)

**Ожидаемый результат:** Работающий конструктор с подстановкой данных

### Этап 5: PDF Engine - Базовая Генерация
**Цель:** Генерация PDF без подписи
- [ ] Интеграция pdf-lib
- [ ] Конвертация HTML/текста шаблона в PDF
- [ ] Форматирование текста (шрифты, размеры, отступы)
- [ ] Поддержка многостраничных документов
- [ ] Экспорт и скачивание PDF
- [ ] Тестирование на различных шаблонах

**Ожидаемый результат:** Генерация корректных PDF-файлов

### Этап 6: Наложение Подписи
**Цель:** Добавление подписи на PDF
- [ ] Загрузка изображения подписи из профиля
- [ ] Реализация опции "С подписью" / "Без подписи"
- [ ] Расчет координат размещения подписи
- [ ] Наложение изображения на PDF (pdf-lib)
- [ ] Настройка размера и позиции подписи
- [ ] Тестирование на различных документах

**Ожидаемый результат:** PDF с корректно размещенной подписью

### Этап 7: Полировка и Оптимизация
**Цель:** Улучшение UX и производительности
- [ ] Адаптация UI под Telegram (цвета, темы)
- [ ] Оптимизация производительности (ленивая загрузка, мемоизация)
- [ ] Обработка ошибок и валидация
- [ ] Улучшение парсера (точность распознавания)
- [ ] Добавление истории документов
- [ ] Тестирование на различных устройствах
- [ ] Подготовка к production

**Ожидаемый результат:** Готовое к production приложение

---

## 8. Дополнительные Требования

### 8.1. Безопасность
- Валидация всех пользовательских данных
- Санитизация HTML в шаблонах
- Защита от XSS
- Ограничение размера загружаемых файлов

### 8.2. Производительность
- Ленивая загрузка компонентов
- Оптимизация работы с IndexedDB
- Кэширование сгенерированных PDF
- Минимизация размера бандла

### 8.3. UX/UI
- Адаптивный дизайн
- Поддержка темной/светлой темы Telegram
- Плавные анимации
- Интуитивная навигация
- Обратная связь при действиях пользователя

---

## 9. Метрики Успеха

- Время генерации PDF < 3 секунд
- Точность парсинга реквизитов > 85%
- Поддержка всех основных типов договоров
- Работа на iOS и Android устройствах
- Удобство использования (субъективная оценка)

---

## 10. Будущие Улучшения

- Облачная синхронизация данных
- Библиотека готовых шаблонов
- Интеграция с электронным документооборотом
- Многопользовательский режим
- История изменений документов
- Экспорт в другие форматы (DOCX, ODT)

---

**Версия документа:** 1.0  
**Дата создания:** 2024  
**Автор:** System Architect
